{% extends 'base.html' %}
{% load search_extras %}

{% block title %}Search{% if query %} — {{ query }}{% endif %}{% endblock %}

{% block canonical %}
  {% if had_query %}
    <link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{% url 'search:index' %}?q={{ query|urlencode }}{% if page_obj.number > 1 %}&page={{ page_obj.number }}{% endif %}" />
  {% endif %}
{% endblock %}

{% block content %}
  <h1 class="mb-3">Search</h1>

  {% with query_help_id="search-query-help" query_status_id="search-query-status" %}
    <form method="get" action="" class="card card-body shadow-sm mb-3" aria-describedby="{% if had_query %}{{ query_help_id }} {{ query_status_id }}{% else %}{{ query_help_id }}{% endif %}">
      <label for="q" class="form-label">Search for an airport or city</label>
      <div class="d-flex gap-2 flex-column flex-md-row align-items-md-end">
        <div class="flex-fill">
          <input
            type="text"
            id="q"
            name="q"
            class="form-control"
            value="{{ query|default:'' }}"
            aria-describedby="{% if had_query %}{{ query_help_id }} {{ query_status_id }}{% else %}{{ query_help_id }}{% endif %}">
          <p id="{{ query_help_id }}" class="form-text mb-0">Type a city, airport name, IATA code, or ICAO ident.</p>
          {% if had_query %}
            <p id="{{ query_status_id }}" class="visually-hidden">Showing results for {{ query }}</p>
          {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
      </div>
    </form>
  {% endwith %}

  {% if not had_query %}
    <p class="text-muted">Enter a term to search airports and cities.</p>
  {% else %}
    <section role="region" aria-label="Search results" aria-live="polite">
      <p><strong>{{ results_count }}</strong> result{{ results_count|pluralize }} for "{{ query }}"</p>

      {% if page_obj and page_obj.object_list %}
        <ul class="list-group list-group-flush">
          {% for kind, obj in page_obj.object_list %}
            {% if kind == 'airport' %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">[Airport] {{ obj.name|highlight:query }}</div>
                    <div class="text-muted small">
                      {% if obj.iata_code %}{{ obj.iata_code|highlight:query }}{% else %}{{ obj.ident|highlight:query }}{% endif %}
                      {% if obj.municipality %} — {{ obj.municipality|highlight:query }}{% endif %}
                      {% if obj.country %}, {{ obj.country.name|highlight:query }}{% endif %}
                    </div>
                  </div>
                </div>
              </li>
            {% elif kind == 'city' %}
              <li class="list-group-item">
                <div class="fw-semibold">[City] {{ obj.name|highlight:query }}</div>
                <div class="text-muted small">{{ obj.country.iso_code }}</div>
              </li>
            {% endif %}
          {% endfor %}
        </ul>

        {% if page_obj.paginator.num_pages > 1 %}
          {% with q_encoded=query|urlencode %}{% include "includes/pagination.html" with querystring='q='|add:q_encoded %}{% endwith %}
        {% endif %}
      {% else %}
        <p class="text-muted" aria-live="polite">No results.</p>
      {% endif %}
    </section>
  {% endif %}
{% endblock %}
