{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ donation.get_food_type_display }} - CFMP{% endblock %}

{% block content %}
<div class="donation-detail">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'donations:list' %}">
                    <i class="bi bi-house me-1"></i>Donations
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ donation.get_food_type_display }}
            </li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main donation details -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <!-- Donation image -->
                <div class="position-relative">
                    {% if donation.image %}
                        <img src="{{ donation.image.url }}" class="card-img-top" 
                             alt="{{ donation.food_type|title }}" style="height: 400px; object-fit: cover;">
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" 
                             style="height: 400px;">
                            <i class="bi bi-{% if donation.food_type == 'produce' %}apple{% elif donation.food_type == 'dairy' %}cup-straw{% elif donation.food_type == 'meat' %}meat{% elif donation.food_type == 'bakery' %}bread-slice{% else %}box-seam{% endif %} text-muted" style="font-size: 6rem;"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Status badge overlay -->
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge fs-6
                            {% if donation.status == 'available' %}bg-success{% elif donation.status == 'claimed' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {% if donation.status == 'available' %}
                                <i class="bi bi-check-circle me-2"></i>Available
                            {% elif donation.status == 'claimed' %}
                                <i class="bi bi-clock me-2"></i>Claimed
                            {% else %}
                                <i class="bi bi-x-circle me-2"></i>{{ donation.get_status_display }}
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Urgency indicator for expiring items -->
                    {% if donation.expiration_date and donation.days_until_expiration <= 3 %}
                    <div class="position-absolute top-0 start-0 m-3">
                        <span class="badge bg-danger fs-6 animate-pulse">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Expires in {{ donation.days_until_expiration }} day{{ donation.days_until_expiration|pluralize }}!
                        </span>
                    </div>
                    {% endif %}
                </div>

                <div class="card-body">
                    <!-- Food type and quantity header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge bg-primary fs-6 mb-2">{{ donation.get_food_type_display }}</span>
                            <h1 class="h3 mb-0">{{ donation.description }}</h1>
                        </div>
                        <div class="text-end">
                            <div class="h4 mb-0 text-primary">{{ donation.quantity }}</div>
                            <small class="text-muted">{{ donation.unit|default:"items" }}</small>
                        </div>
                    </div>

                    <!-- Details grid -->
                    <div class="row g-3 mb-4">
                        {% if donation.expiration_date %}
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-light me-3">
                                    <i class="bi bi-calendar-event text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">Expiration Date</div>
                                    <div class="text-muted">{{ donation.expiration_date|date:"F j, Y" }}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-light me-3">
                                    <i class="bi bi-calendar-plus text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">Posted</div>
                                    <div class="text-muted">{{ donation.created_at|date:"F j, Y" }} ({{ donation.created_at|timesince }} ago)</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-light me-3">
                                    <i class="bi bi-geo-alt text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">Pickup Location</div>
                                    <div class="text-muted">{{ donation.pickup_location }}</div>
                                </div>
                            </div>
                        </div>

                        {% if donation.pickup_instructions %}
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-light me-3">
                                    <i class="bi bi-info-circle text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">Pickup Instructions</div>
                                    <div class="text-muted">{{ donation.pickup_instructions|truncatechars:50 }}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Detailed pickup instructions -->
                    {% if donation.pickup_instructions %}
                    <div class="border rounded p-3 mb-4 bg-light">
                        <h5 class="mb-2">
                            <i class="bi bi-clipboard-check me-2"></i>Pickup Instructions
                        </h5>
                        <p class="mb-0">{{ donation.pickup_instructions|linebreaks }}</p>
                    </div>
                    {% endif %}

                    <!-- Nutrition/safety info -->
                    {% if donation.food_type == 'meat' or donation.food_type == 'dairy' or donation.expiration_date %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Food Safety Notice:</strong>
                        {% if donation.food_type == 'meat' %}
                            Please ensure proper cold storage and check temperature upon pickup.
                        {% elif donation.food_type == 'dairy' %}
                            Refrigerate immediately upon pickup and check expiration date.
                        {% elif donation.expiration_date %}
                            Please verify freshness and condition before consumption.
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Action card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-hand-thumbs-up me-2"></i>Take Action
                    </h5>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated and user.pantry and donation.status == 'available' %}
                        <!-- Claim button for pantries -->
                        <button type="button" class="btn btn-success btn-lg w-100 mb-3" 
                                data-bs-toggle="modal" data-bs-target="#claimModal">
                            <i class="bi bi-hand-thumbs-up me-2"></i>Claim This Donation
                        </button>
                        <p class="text-muted small mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            By claiming this donation, you commit to picking it up within the specified timeframe.
                        </p>
                    {% elif user.is_authenticated and user.donor and donation.donor == user.donor %}
                        <!-- Owner actions -->
                        <div class="d-grid gap-2">
                            <a href="{% url 'donations:update' donation.pk %}" class="btn btn-outline-primary">
                                <i class="bi bi-pencil me-2"></i>Edit Donation
                            </a>
                            {% if donation.status == 'available' %}
                            <button type="button" class="btn btn-outline-danger" 
                                    data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash me-2"></i>Delete Donation
                            </button>
                            {% endif %}
                        </div>
                    {% elif donation.status == 'claimed' %}
                        <!-- Already claimed -->
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            This donation has been claimed by a food pantry.
                        </div>
                    {% elif donation.status == 'completed' %}
                        <!-- Completed donation -->
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            This donation has been successfully completed.
                        </div>
                    {% elif not user.is_authenticated %}
                        <!-- Not logged in -->
                        <div class="d-grid gap-2">
                            <a href="{% url 'auth:login' %}?next={{ request.path }}" class="btn btn-primary">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Login to Claim
                            </a>
                            <a href="{% url 'auth:register' %}" class="btn btn-outline-primary">
                                <i class="bi bi-person-plus me-2"></i>Register as Pantry
                            </a>
                        </div>
                    {% else %}
                        <!-- Wrong user type -->
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Only registered food pantries can claim donations.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Donor info card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-person-heart me-2"></i>Donor Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-person" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">{{ donation.donor.user.get_full_name|default:"Anonymous Donor" }}</div>
                            {% if donation.donor.organization %}
                                <div class="text-muted small">{{ donation.donor.organization }}</div>
                            {% endif %}
                            <div class="text-muted small">
                                Member since {{ donation.donor.user.date_joined|date:"F Y" }}
                            </div>
                        </div>
                    </div>

                    {% if donation.donor.bio %}
                    <p class="text-muted small">{{ donation.donor.bio|truncatechars:100 }}</p>
                    {% endif %}

                    <!-- Donor stats -->
                    <div class="row text-center g-2">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-primary">{{ donation.donor.total_donations|default:0 }}</div>
                                <div class="text-muted small">Total Donations</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-success">{{ donation.donor.successful_donations|default:0 }}</div>
                                <div class="text-muted small">Completed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Claim Modal -->
{% if user.is_authenticated and user.pantry and donation.status == 'available' %}
<div class="modal fade" id="claimModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-hand-thumbs-up me-2"></i>Claim Donation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'donations:claim' donation.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Important:</strong> By claiming this donation, you agree to pick it up within the specified timeframe and follow all pickup instructions.
                    </div>

                    <!-- Donation summary -->
                    <div class="border rounded p-3 bg-light mb-4">
                        <h6 class="mb-2">Donation Summary</h6>
                        <div class="row">
                            <div class="col-8">
                                <strong>{{ donation.get_food_type_display }}</strong><br>
                                {{ donation.description }}<br>
                                <small class="text-muted">{{ donation.pickup_location }}</small>
                            </div>
                            <div class="col-4 text-end">
                                <div class="h5 mb-0 text-primary">{{ donation.quantity }}</div>
                                <small class="text-muted">{{ donation.unit|default:"items" }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Claim form -->
                    <div class="mb-3">
                        <label for="pickup_notes" class="form-label">Pickup Notes</label>
                        <textarea name="pickup_notes" id="pickup_notes" class="form-control" rows="3" 
                                  placeholder="Any special instructions, timing preferences, or contact information..."></textarea>
                        <div class="form-text">Optional: Provide any additional information for the donor.</div>
                    </div>

                    <div class="mb-3">
                        <label for="expected_pickup_date" class="form-label">Expected Pickup Date</label>
                        <input type="date" name="expected_pickup_date" id="expected_pickup_date" class="form-control" 
                               min="{{ today|date:'Y-m-d' }}" required>
                        <div class="form-text">When do you plan to pick up this donation?</div>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="confirm_terms" required>
                        <label class="form-check-label" for="confirm_terms">
                            I confirm that I will pick up this donation according to the provided instructions and contact the donor if there are any issues.
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-hand-thumbs-up me-1"></i>Claim Donation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Modal -->
{% if user.is_authenticated and user.donor and donation.donor == user.donor and donation.status == 'available' %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Donation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this donation? This action cannot be undone.</p>
                <div class="border rounded p-3 bg-light">
                    <strong>{{ donation.get_food_type_display }}</strong><br>
                    {{ donation.description }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{% url 'donations:delete' donation.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Donation
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Custom styles -->
<style>
.icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-circle {
    flex-shrink: 0;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.animate-pulse {
    animation: pulse 2s infinite;
}

.card {
    border: none;
    border-radius: 12px;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
}
</style>

<!-- Set default pickup date to tomorrow -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pickupDateInput = document.getElementById('expected_pickup_date');
    if (pickupDateInput) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        pickupDateInput.value = tomorrow.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}